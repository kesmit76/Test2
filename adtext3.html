<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ads.txt Checker</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f7f7f7; }
    textarea { width: 100%; height: 200px; padding: 10px; font-size: 14px; }
    button { padding: 10px 20px; font-size: 16px; margin: 10px 5px 0 0; cursor: pointer; }
    .result-block { margin-top: 15px; padding: 10px; background: #fff; border: 1px solid #ccc; white-space: pre-wrap; }
    .error { color: red; }
  </style>
</head>
<body>
  <h2>ads.txt Checker</h2>
  <p>Paste up to 500 domains (one per line):</p>
  <textarea id="domainList"></textarea><br>
  <button onclick="beginCheck()">Begin</button>
  <button onclick="exportCSV()">Export to CSV</button>
  <div id="results"></div>

  <script>
    const results = [];

    function sleep(ms) {
      return new Promise(r => setTimeout(r, ms));
    }

    function fetchWithTimeout(url, timeout = 1000) {
      return Promise.race([
        fetch(url),
        new Promise((_, reject) =>
          setTimeout(() => reject(new Error("Timeout after 1 second")), timeout)
        )
      ]);
    }

    async function beginCheck() {
      results.length = 0;
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "";
      const domains = document.getElementById("domainList").value
        .split("\n")
        .map(s => s.trim())
        .filter(s => s)
        .slice(0, 500);

      for (const d of domains) {
        const domain = d.startsWith("www.") ? d : "www." + d;
        const targetURL = `https://${domain}/ads.txt`;
        const proxyURL = `https://corsproxy.io/?${encodeURIComponent(targetURL)}`;

        const block = document.createElement("div");
        block.className = "result-block";
        block.textContent = `${targetURL} â†’ Checking...`;
        resultsDiv.appendChild(block);

        try {
          const resp = await fetchWithTimeout(proxyURL, 1000);

          if (!resp.ok) {
            throw new Error("HTTP " + resp.status);
          }

          const ct = resp.headers.get("content-type") || "";
          if (!ct.includes("text/plain")) {
            throw new Error("Not plain text (Content-Type: " + ct + ")");
          }

          const txt = await resp.text();
          block.textContent = `${targetURL}:\n${txt.trim()}`;
          results.push([targetURL, txt.replace(/\r?\n/g, '\\n'), resp.status]);
        } catch (err) {
          const msg = err.message.includes("Timeout")
            ? "Page did not load"
            : err.message.startsWith("Not plain text")
              ? "Response not ads.txt"
              : (err.message.startsWith("HTTP") ? "No ads.txt file found" : err.message);
          block.innerHTML = `<strong>${targetURL}</strong><br><span class="error">${msg}</span>`;
          results.push([targetURL, msg, "Error"]);
        }

        await sleep(150);
      }
    }

    function exportCSV() {
      if (!results.length) {
        alert("Please run the check first.");
        return;
      }

      let csvContent = "URL,Content,Status\n";
      results.forEach(([url, content, status]) => {
        const row = [url, content, status].map(v => `"${v.replace(/"/g, '""')}"`).join(",");
        csvContent += row + "\n";
      });

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "ads_txt_results.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
